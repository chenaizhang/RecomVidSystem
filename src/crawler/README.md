# 短视频推荐系统-数据采集模块

## 项目简介
本项目是短视频推荐系统的数据采集模块，主要完成**视频信息采集**（对应需求F1）和**用户行为模拟**（对应需求F2）功能，为推荐系统提供基础数据支撑。

## 已实现功能
### F1：视频信息库构建（≥10万条）
通过B站视频搜索接口，爬取关键词为`智能安防设备`的短视频信息，存储至`item.csv`。包含字段：
- 标题、作者、bvid（视频唯一标识）、上传时间、视频时长、弹幕数、点赞数、播放量、收藏量、分区类型、标签、描述

### F2：用户行为模拟（≥1万用户）
1. 通过B站用户空间接口爬取真实用户基础信息（mid、昵称、性别、等级等）
2. 生成正态分布的用户年龄（均值37岁，范围14-60岁）
3. 处理后数据存储至`user.csv`，包含字段：id、mid、昵称、性别、关注数、粉丝数、年龄

## 目录结构
```
短视频推荐系统/
├── scraper.py       # B站视频信息爬虫
├── code.py          # B站用户信息爬虫
├── process_user_info.py  # 用户数据处理脚本
├── item.csv         # 视频信息存储文件（F1输出）
├── user.csv         # 处理后用户信息存储文件（F2输出）
└── README.md        # 项目说明文档
```

## 依赖环境
- Python 3.8+
- 第三方库：requests（网络请求）、pandas（数据处理）、numpy（数值计算）、concurrent（多线程）

## 运行步骤
### 1. 安装依赖
```bash
pip install requests pandas numpy
```

### 2. 爬取视频信息（F1）
修改`scraper.py`中的`search_keyword`（默认`智能安防设备`）和`max_page`（默认30页）后运行：
```bash
python scraper.py
```
输出文件：`item.csv`（追加模式，重复运行会累积数据）

### 3. 爬取并处理用户信息（F2）

#### 3.1 用户信息爬取（`code.py`实现）
采用**多线程并发爬取**提升效率，核心流程如下：
1. **URL生成**：根据用户mid范围生成B站用户空间URL（格式：`https://m.bilibili.com/space/{mid}`）
2. **请求构造**：
   - 使用iPhone浏览器的User-Agent（`uas`变量）模拟移动端请求
   - 携带`buvid3` Cookie维持会话（需定期更新以避免封禁）
3. **数据解析**：
   - 通过正则表达式提取用户昵称（`r'"name":"(.*?)"'`）和性别（`r'"sex":"(.*?)"'`）
   - 基于页面中的`lv0`~`lv6` CSS类名判断用户等级
   - 调用B站关系接口（`https://api.bilibili.com/x/relation/stat`）获取关注数和粉丝数
4. **线程安全**：使用`threading.Lock`保证多线程写入临时列表`result`的安全性
5. **数据保存**：每批次爬取完成后调用`save()`函数将临时数据写入`user_info11.csv`（避免内存溢出）

示例代码片段（多线程执行部分）：
```python
with futures.ThreadPoolExecutor(10) as executor:
    executor.map(run, urls)  # 最大10个线程并发执行
```

#### 3.2 用户数据处理（`process_user_info.py`实现）
对原始爬取数据进行清洗和特征工程，具体步骤：
1. **数据读取**：使用`pd.read_csv('user_info.csv', encoding='gb18030')`读取原始数据（解决中文乱码）
2. **字段删除**：通过`df.drop('level', axis=1)`移除无用的等级字段（假设业务不需要）
3. **年龄生成**：
   - 采用正态分布模拟真实用户年龄（均值μ=37，标准差σ=10）
   - 使用`np.clip(age, 14, 60)`截断不合理年龄（<14或>60岁）
   - 示例代码：
   ```python
   age = np.random.normal(37, 10, len(df))  # 生成正态分布随机数
   age = np.clip(age, 14, 60).astype(int)  # 截断并转为整数
   ```
4. **id重编号**：通过`df['id'] = range(1, len(df)+1)`生成从1开始的连续唯一id
5. **数据保存**：使用`df.to_csv('user.csv', index=False, encoding='utf-8')`输出最终数据（通用编码）

### 2. 视频信息爬取（F1，`scraper.py`实现）
通过B站搜索接口（`https://api.bilibili.com/x/web-interface/search/type`）采集视频信息，核心逻辑：
1. **分页爬取**：通过循环`page`参数遍历指定页数（`max_page`控制）
2. **请求参数**：
   - `search_type=video`（指定搜索类型为视频）
   - `keyword`为搜索关键词（默认`智能安防设备`）
3. **数据清洗**：
   - 使用正则表达式`re.compile(r'<[^>]+>', re.S)`清理标题中的HTML高亮标签（如`<em>`）
   - 处理可能缺失的字段（如`video_review`弹幕数，使用`data.get('video_review', 0)`避免KeyError）
4. **数据存储**：
   - 使用`pd.DataFrame`将字典列表转为DataFrame
   - 通过`f.tell()==0`判断文件是否为空，仅首行写入表头（避免重复）

示例代码片段（数据写入部分）：
```python
with open(out_file, 'a', encoding='utf-8-sig', newline='') as f:
    df.to_csv(f, index=False, header=f.tell()==0)  # 仅首行写入表头
```

## 数据说明
### item.csv（视频信息）
| 字段       | 说明                     | 示例                  |
|------------|--------------------------|-----------------------|
| 标题       | 视频标题（清理HTML标签后）| 智能安防设备实战演示  |
| 作者       | 视频上传用户昵称         | 科技小栈              |
| bvid       | B站视频唯一标识          | BV123456789           |
| 上传时间   | 格式化后的时间（YYYY-MM-DD HH:MM:SS） | 2024-05-20 14:30:00  |
| 视频时长   | 时长（秒）               | 300                   |
| 弹幕数     | 视频弹幕数量             | 1200                  |
| 点赞数     | 视频点赞数量             | 890                   |
| 播放量     | 视频播放次数             | 56000                 |
| 收藏量     | 视频收藏次数             | 320                   |
| 分区类型   | 视频所属分区             | 科技-数码              |
| 标签       | 视频标签（逗号分隔）     | 安防,智能设备,教程    |
| 描述       | 视频简介                 | 本视频讲解...         |

### user.csv（用户信息）
| 字段       | 说明                     | 示例       |
|------------|--------------------------|------------|
| id         | 自增唯一标识（从1开始）  | 1          |
| mid        | B站用户唯一标识          | 123456789  |
| 昵称       | 用户昵称                 | 安防爱好者  |
| 性别       | 用户性别（未知/男/女）    | 男         |
| 关注数     | 用户关注的UP主数量       | 50         |
| 粉丝数     | 用户的粉丝数量           | 1200       |
| 年龄       | 模拟生成的年龄（14-60岁）| 32         |

## 后续计划
将逐步实现以下功能（F3-F7）：
- F3：用户兴趣相似群体分析
- F4：基于浏览记录的视频推荐
- F5：视频热度变化预测
- F6/F7：视频与用户聚类分析
